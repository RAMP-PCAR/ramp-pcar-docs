/*! ramp-gis-viewer 23-05-2014 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/query","dojo/_base/array","dojo/dom-class","dojo/dom-attr","dojo/dom-construct","dojo/topic","dojo/on","dojo/Deferred","dojo/text!./templates/datagrid_template.json","dojo/text!./templates/extended_datagrid_template.json","esri/layers/FeatureLayer","esri/tasks/query","ramp/ramp","ramp/graphicExtension","ramp/globalStorage","ramp/datagridClickHandler","ramp/map","ramp/eventManager","utils/util","utils/array","utils/dictionary","utils/popupManager","utils/tmplHelper"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y){"use strict";function z(a){return o.getLayerConfig(a).datagrid}function A(a,b){("keypress"===a.type&&13===a.keyCode||"click"===a.type)&&b()}function B(a){var b={},c=s.getVisibleFeatureLayers(),e=new n;"summary"!==W.getDatagridMode()&&(c=d.filter(c,function(a){return a.url===W.getSelectedDatasetUrl()})),e.geometry=s.getMap().extent,e.outFields=["*"];var f=d.map(c,function(a){return a.queryFeatures(e).then(function(a){if(a.features.length>0){var c=a.features[0].getLayer(),d=c.url;b[d]=c.visible?a.features:[]}})});u.afterAll(f,function(){D(b),a&&a.resolve()})}function C(a){var b,c=a.getLayer().url;if(W.getDatagridMode()===N)b=[a.attributes[o.getLayerConfig(c).nameField]];else{b=[];var e=z(c).gridColumns;d.forEach(e,function(c){b.push(a.attributes[c.fieldName]||"")})}return b.push({featureUrl:c,layerName:o.getLayerConfig(c).displayName,feature:a}),b}function D(a){if(K.dataTable().fnClearTable(),K.dataTable().fnPageChange(0),!Object.keys(a).isEmpty()){var b=[];w.forEachEntry(a,function(a,c){b=b.concat(d.map(c,function(a){return a[W.getDatagridMode()]?a[W.getDatagridMode()]:a[W.getDatagridMode()]=C(a)}))}),b.sort(S[W.getDatagridMode()][T]),u.subscribeOnce(t.Datagrid.DRAW_COMPLETE,function(){W.activateRows(),W.adjustPanelWidth(),h.publish(t.Datagrid.EXTENT_FILTER_END)});try{K.dataTable().fnAddData(b)}catch(c){}}}function E(a){var b=a.data(V),c=parseInt(a.data(U)),d=s.getFeatureLayer(b),e=v.binaryFind(d.graphics,function(a){return p.getOid(a)-c});return e}function F(){h.subscribe(t.FilterManager.LAYER_VISIBILITY_TOGGLED,function(){R=!0}),h.subscribe(t.FilterManager.GLOBAL_LAYER_VISIBILITY_TOGGLED,function(){R=!0}),h.subscribe(t.GUI.TAB_SELECTED,function(a){"datagrid"===a.tabName&&R?(R=!1,B()):"datagrid"!==a.tabName||R?W.adjustPanelWidth():W.capturePanel()}),h.subscribe(t.GUI.TAB_DESELECTED,function(a){"datagrid"===a.tabName&&(W.onHide(),h.publish(t.GUI.SUBPANEL_DOCK,{origin:"datagrid"}))}),h.subscribe(t.Datagrid.APPLY_EXTENT_FILTER,function(){W.isReady()?B():W.init()})}var G,H,I,J,K,L,M,N="summary",O="full",P=JSON.parse(y.stringifyTemplate(k)),Q=JSON.parse(y.stringifyTemplate(l)),R=!0,S={},T="ascending",U="feature-oid",V="feature-url",W=function(){function a(a){function b(a){var b=C(a),c=K.dataTable().fnGetData();return v.binaryIndexOf(c,function(a){return S[W.getDatagridMode()][T](a,b)})}var c=-1,d=null;return{graphic:null,focusedButton:null,navigateToRow:function(){if(-1!==c){var a=Math.floor(c/I.rowsPerPage);return K.dataTable().fnPageChange(a),_.scrollTo(d,300,{axis:"y",offset:{left:0,top:1.5*-d.height()}}),!0}return!1},update:function(){this.graphic?(c=b(this.graphic),-1!==c&&(d=$(K.dataTable().fnGetNodes(c)))):c=-1},getNode:function(){return this.update(),d},activate:function(){this.graphic&&(this.getNode().addClass(a),this.focusedButton&&(d.find(this.focusedButton).focus(),this.focusedButton=null))},deactivate:function(){this.graphic&&(this.getNode().removeClass(a),this.graphic=null)}}}function b(){var a={buttonLabel:"Sort",classAddition:"font-medium global-button",someAttribute:""};return a}function e(a,b,c,e){var f,g=c.last(),h=W.getDatagridMode();if(h===N){if(u.isUndefined(g[h])){var i=z(g.featureUrl).summaryRowTemplate;tmpl.cache={},tmpl.templates=P,f=y.dataBuilder(g.feature,g.featureUrl),g[h]=tmpl(i,f)}return g[h]}if(u.isUndefined(g[h])){g[h]=[];var j=z(g.featureUrl).gridColumns;tmpl.cache={},tmpl.templates=Q,f=y.dataBuilder(g.feature,g.featureUrl),d.forEach(j,function(a,b){f.columnIdx=b,g[h].push(tmpl(a.columnTemplate,f))})}return g[h][e.col]}function f(){var a={dom:'<"jqgrid_table_wrapper"t><"status-line"p>',info:!1,deferRender:!0,paging:!0,pagingType:"full_numbers",scrollX:!1,destroy:!0,searching:!1,pageLength:I.rowsPerPage,drawCallback:function(){h.publish(t.Datagrid.DRAW_COMPLETE)}};cb===N?(a.columnDefs={targets:0,orderable:!1},a.columns=[{title:"Name",width:"300px",type:"string",className:"",render:e}]):(a.columnDefs={},a.columns=d.map(z(W.getSelectedDatasetUrl()).gridColumns,function(a){return{title:a.title,width:a.width,type:a.sortType,className:a.alignment?"":"center",render:e}})),J=K.DataTable(a).on("page",function(){h.publish(t.GUI.SUBPANEL_DOCK,{origin:"datagrid"})}),Z=H.find("#jqgrid_wrapper"),_=H.find(".jqgrid_table_wrapper")}function g(){x.registerPopup(H,"hoverIntent",function(){this.target.attr("title")&&(this.target.isOverflowed()?this.target.tooltipster({theme:".tooltipster-dark"}).tooltipster("show"):this.target.removeAttr("title"))},{handleSelector:".point-name, .category-name",useAria:!1,timeout:500})}function i(){H.on("click","button.details",function(){var a=$(this),b=a.parents(".record-row").parent().parent();if(ab.focusedButton="button.details",ab.graphic&&ab.getNode()[0]===b[0])r.onDetailDeselect(cb);else{var c=E(a);r.onDetailSelect(a,c,cb)}}),H.on("click","button.zoomto",function(a){var b=$(this);bb.focusedButton="button.zoomto",b.text()===G.stringResources.txtGrid_zoomTo?A(a,function(){L=E(b),M=s.getMap().extent.clone(),r.onZoomTo(s.getMap().extent.clone(),L),u.subscribeOnce(t.Datagrid.EXTENT_FILTER_END,function(){var a=$(String.format("button.zoomto[data-{0}='{1}'][data-{2}='{3}']:eq(0)",U,p.getOid(L),V,L.getLayer().url));a.text(G.stringResources.txtGrid_zoomBack)})}):(r.onZoomBack(L),b.text(G.stringResources.txtGrid_zoomTo))}),H.on("click","button.global-button",function(){var a=$(this);"ascending"===T?(a.addClass("state-expanded"),T="descending"):(a.removeClass("state-expanded"),T="ascending"),B()}),H.on("click","button.expand",function(){cb=cb===N?O:N,W.updateInit(),db=!1,h.publish("gui/grid/expand")}),H.on("change","#dataset_selector",function(){$(this);R=$("#dataset_selector option:selected").length>0?$("#dataset_selector option:selected")[0].value:"",D()}),x.registerPopup(H,"hover, focus",function(a){this.target.removeClass("wb-invisible"),a.resolve()},{handleSelector:"tr",targetSelector:".record-controls",closeHandler:function(a){this.target.addClass("wb-invisible"),a.resolve()},activeClass:"background-light",useAria:!1})}function k(){_.scroll(function(){var a=_.scrollTop();0===a?Y.removeClass("scroll"):Y.addClass("scroll")}),_.scroll(function(){var a=_.scrollTop()+_.outerHeight()-X.outerHeight();a-Y.outerHeight()===K.height()?X.removeClass("scroll"):X.addClass("scroll")})}function l(a){m(),ab.graphic=a.graphic,a.scroll&&W.activateRows()}function m(){ab.deactivate(),r.onZoomCancel()}function n(a){bb.graphic=a.graphic}function o(){bb.deactivate()}function w(){h.subscribe(t.Datagrid.HIGHLIGHTROW_SHOW,l),h.subscribe(t.Datagrid.HIGHLIGHTROW_HIDE,m),h.subscribe(t.Datagrid.ZOOMLIGHTROW_SHOW,n),h.subscribe(t.Datagrid.ZOOMLIGHTROW_HIDE,o)}function D(){tmpl.cache={},tmpl.templates=P,Z.replaceWith(tmpl("datagrid_manager_table_Template",{tableId:"jqgrid",tableCss:"display table-condensed table-simplify"})),K=H.find("table"),f(),db=!0,B()}function F(a){var d,e=b(),g={buttons:e,tableId:"jqgrid",tableCss:"display table-condensed table-simplify"},h="",i=new j;tmpl.cache={},h="summary"===cb?"datagrid_manager_Template":"datagrid_full_manager_Template",tmpl.templates=P,"summary"!==cb&&(g.buttons.datasets=q.config.featureLayers),d=tmpl(h,g),H=$("#"+q.config.divNames.datagrid);var k=.5,l=new TimelineLite({paused:!0,onComplete:function(){}});l.set(H,{className:"+=animated fadeOut"}),l.call(function(){l.pause(),K=H.empty().append(d).find("table"),f(),Y=H.find("#datagridGlobalToggles"),X=H.find(".status-line"),a&&a.resolve(),c("tbody").removeAttr("role"),db=!0,i.then(function(){l.resume()}),B(i)},null,this,k+.1),l.set(H,{className:"-=fadeOut"}),l.set(H,{className:"+=fadeIn"}),l.set(H,{className:"-=animated fadeIn"},"+="+k),l.play()}var H,R,X,Y,Z,_,ab=a("selected-row"),bb=a("highlighted-row"),cb=N,db=!1;return{init:u.once(function(){var a=new j;a.then(function(){g(),i(),k(),w()}),F(a)}),updateInit:function(){F()},getDatagridMode:function(){return cb},getSelectedDatasetUrl:function(){return R||(R=$("#dataset_selector option:selected").length>0?$("#dataset_selector option:selected")[0].value:""),R},isReady:function(){return db},onHide:u.once(function(){H.removeClass("animated fadeIn")}),adjustPanelWidth:function(){u.adjustWidthForSrollbar(_,[Y,X])},activateRows:function(){ab.update(),bb.update(),ab.navigateToRow()||bb.navigateToRow(),bb.activate(),ab.activate(),this.capturePanel()},capturePanel:function(){ab.graphic&&h.publish(t.GUI.SUBPANEL_CAPTURE,{target:ab.getNode().find(".record-controls"),consumeOrigin:"datagrid",origin:"datagrid"})}}}();return{init:function(){function a(a,b){var c=a[0].localeCompare(b[0]);return 0===c&&(c=a[1]-b[1],0===c&&(c=a.last().featureUrl.localeCompare(b.last().featureUrl))),c}function b(a,b){return a[1].localeCompare[b[1]]}G=q.config,H=G.featureLayers,I=H[0].datagrid,F(),S.summary={ascending:a,descending:function(b,c){return a(c,b)}},S.full={ascending:b,descending:function(a,c){return b(c,a)}}}}});