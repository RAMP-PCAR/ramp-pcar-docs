/*! ramp-gis-viewer 23-05-2014 */
define(["dojo/_base/declare","dojo/_base/lang","dojo/query","dojo/_base/array","dojo/dom","dojo/dom-class","dojo/dom-style","dojo/dom-construct","dojo/_base/connect","dojo/Deferred","dojo/topic","dojo/aspect","dojo/promise/all","dojo/text!./templates/filter_row_template.json","esri/tasks/query","esri/layers/FeatureLayer","ramp/ramp","ramp/globalStorage","ramp/map","ramp/eventManager","utils/tmplHelper","utils/util","utils/array","utils/dictionary","utils/popupManager"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y){"use strict";function z(){k.subscribe(t.GUI.TAB_DESELECTED,function(a){"filterManager"===a.tabName&&k.publish(t.GUI.SUBPANEL_CLOSE,{origin:"filterManager"})})}var A,B,C=function(){function a(){function a(a){j.setAll(a),k.publish(t.FilterManager.GLOBAL_LAYER_VISIBILITY_TOGGLED,{checked:a})}function b(a){l.setAll(a),k.publish(t.FilterManager.GLOBAL_BOX_VISIBILITY_TOGGLED,{checked:a})}function c(a,b){var c=d.every(j.getNodes(),function(a){return $(a).is(":checked")});h.setAll(c),k.publish(t.FilterManager.LAYER_VISIBILITY_TOGGLED,{checked:a,node:b[0]})}function e(a,b){var c=d.every(l.getNodes(),function(a){return $(a).is(":checked")});i.setAll(c),k.publish(t.FilterManager.BOX_VISIBILITY_TOGGLED,{checked:a,node:b[0]})}var h,i,j,l;h=v.styleCheckboxes(g.find(".checkbox-custom .eye + input"),"checked","focused",{checked:B.txtHideAllFeatures,unchecked:B.txtShowAllFeatures}),i=v.styleCheckboxes(g.find(".checkbox-custom .box + input"),"checked","focused",{checked:B.txtHideAllBounds,unchecked:B.txtShowAllBounds}).setAll(!1),j=v.styleCheckboxes(f.find(".checkbox-custom .eye + input"),"checked","focused",{checked:B.txtHideFeatures,unchecked:B.txtShowFeatures}),l=v.styleCheckboxes(f.find(".checkbox-custom .box + input"),"checked","focused",{checked:B.txtHideBounds,unchecked:B.txtShowBounds}).setAll(!1),k.subscribe(t.FilterManager.TOGGLE_GLOBAL_LAYER_VISIBILITY,function(b){h.setAll(b.visible),a(b.visible)}),k.subscribe(t.FilterManager.TOGGLE_GLOBAL_BOX_VISIBILITY,function(a){i.setAll(a.visible),b(a.visible)}),h.getNodes().on("change",function(){var b=$(this).is(":checked");a(b)}),i.getNodes().on("change",function(){var a=$(this).is(":checked");b(a)}),k.subscribe(t.FilterManager.TOGGLE_LAYER_VISIBILITY,function(a){j.setState(function(b){var c=$(b).findInputLabel().data("layer-id");return a.layerIds.contains(c)}),d.forEach(j.getNodes(),function(b){b=$(b);var d=b.findInputLabel().data("layer-id");c(a.layerIds.contains(d),b)})}),k.subscribe(t.FilterManager.TOGGLE_BOX_VISIBILITY,function(a){l.setState(function(b){var c=$(b).findInputLabel().data("layer-id");return a.layerIds.contains(c)}),d.forEach(l.getNodes(),function(b){b=$(b);var c=b.findInputLabel().data("layer-id");e(a.layerIds.contains(c),b)})}),j.getNodes().on("change",function(){var a=$(this),b=a.is(":checked");c(b,a)}),l.getNodes().on("change",function(){var a=$(this),b=a.is(":checked");e(b,a)})}function b(){y.registerPopup(f,"hoverIntent",function(){this.target.attr("title")&&(this.target.isOverflowed()?this.target.tooltipster({theme:".tooltipster-dark"}).tooltipster("show"):this.target.removeAttr("title"))},{handleSelector:".layer-name span",useAria:!1,timeout:500})}function c(){function a(){v.adjustWidthForSrollbar(f,[g])}function b(){var a=e.length,b=e.filter(":hidden").length;0===b?c.open():b===a&&c.close()}var c,d=g.find(".global-button"),e=f.find(".layerList-container:hidden"),h=f.find("button.legend-button");h.map(function(){var c=$(this),d=c.parents("fieldset").find("> .layerList-container");y.registerPopup(c,"state-expanded",d,"click",function(c){d.slideToggle(400,function(){a(),b(),c.resolve()})},"same")}),c=y.registerPopup(d,"state-expanded",e,"click",function(b){e.slideDown(400,function(){h.addClass("state-expanded"),a(),b.resolve()})},function(b){e.slideUp(400,function(){h.removeClass("state-expanded"),$("#tabs1_1-parent").scrollTop(0),a(),b.resolve()})}),f.find("legend button.metadata-button").on("click",function(){var a=$(this).parents("legend");if(a.hasClass("selected-row"))k.publish(t.GUI.SUBPANEL_CLOSE,{origin:"filterManager"});else{var b,c=$(this).data("layer-uuid");k.publish(t.GUI.SUBPANEL_OPEN,{panelName:B.txtMetadata,title:a.find(".layer-name span").text(),content:null,target:a.find(".layer-details"),origin:"filterManager",guid:c,doOnOpen:function(){a.addClass("selected-row")},doOnHide:function(){f.find(".selected-row").removeClass("selected-row")}}),b="assets/metadata/"+c+".xml",v.transformXML(b,"assets/metadata/xstyle_default_"+A.lang+".xsl",function(a){k.publish(t.GUI.SUBPANEL_OPEN,{content:$(a),origin:"filterManager",update:!0,guid:c})})}})}function e(){f.scroll(function(){var a=f.scrollTop();0===a?g.removeClass("scroll"):g.addClass("scroll")})}var f,g;return{init:function(){tmpl.cache={},tmpl.templates=JSON.parse(u.stringifyTemplate(n));var h=s.getMap().getLayersVisibleAtScale(),i=new Array;d.forEach(h,function(a){a.type&&"basemap"!==a.type&&(a.layerConfig=q.getLayerConfig(a.url),i.push(a))});var j,l=u.genericDataBuilder(i),m=$("#"+r.config.divNames.filter);j=tmpl("filter_manager_template",l),m.addClass("animated fadeOut"),window.setTimeout(function(){m.empty().append(j).removeClass("fadeOut").addClass("animated fadeIn"),window.setTimeout(function(){m.removeClass("animated fadeIn")},300),f=$("#layerList"),f.find("> li").length>1&&f.sortable({axis:"y",handle:".sort-handle",placeholder:"sortable-placeholder",update:function(a,b){var c=b.item[0].id,e=d.indexOf($("#layerList").sortable("toArray"),c);k.publish(t.GUI.SUBPANEL_CLOSE,{origin:"rampPopup,datagrid"}),k.publish(t.FilterManager.SELECTION_CHANGED,{id:c,index:e})}}),g=$("#filterGlobalToggles"),a(),b(),c(),e(),k.publish(t.FilterManager.UI_COMPLETE)},300)}}}();return{init:function(){A=r.config,B=r.config.stringResources,B.txtShowFeatures="Show {0}",B.txtHideFeatures="Hide {0}",B.txtShowAllFeatures="Show All",B.txtHideAllFeatures="Hide All",B.txtShowBounds="Show Bounds of {0}",B.txtHideBounds="Hide Bounds of {0}",B.txtShowAllBounds="Show All Bounds",B.txtHideAllBounds="Hide All Bounds",z(),C.init()},_getFeatures:function(a){var b=new o;return b.returnGeometry=!1,b.maxAllowableOffset=1e3,b.where=a.objectIdField+">0",a.queryFeatures(b)},_getField:function(a,b){var c=new j;return this._getFeatures(a).then(function(a){c.resolve(d.map(a.features,function(a){return a.attributes[b]}))}),c.promise}}});