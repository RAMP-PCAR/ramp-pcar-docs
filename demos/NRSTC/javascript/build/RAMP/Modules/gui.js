/*! ramp-gis-viewer 23-05-2014 */
define(["dojo/_base/array","dojo/topic","dojo/_base/lang","dojo/Deferred","ramp/globalStorage","ramp/eventManager","dojo/text!./templates/sub_panel_Template.html","dojo/text!./templates/sub_panel_content_Template.html","utils/util","utils/dictionary","utils/popupManager","dojo/domReady!"],function(a,b,c,d,e,f,g,h,i,j,k){"use strict";function l(a){var b=Object.create(E);return b._attr=Object.create(D),b.create(a),n(b),b}function m(a,c,d){b.publish(f.GUI.SUBPANEL_CHANGE,{visible:a,origin:c,container:d,offsetLeft:d?d.width()+25+w.getPanelWidth():w.getPanelWidth()})}function n(a){function b(a,b){a&&(a.getContainer().height(t-$("#map-toolbar").height()),b&&b.resolve(!0))}a?b(a):i.executeOnDone(C,b)}function o(){}function p(a){var b,e=new d;e.then(function(){a=b.getAttributes(),b=C[a.origin],$(".viewport").hasClass("full-data-mode")&&TweenLite.fromTo("#panel-div",.5,{right:0,ease:"easeOutCirc"},{left:35,right:430,ease:"easeOutCirc"}),b.open(),b.getPanel().find(".sub-panel-toggle").on("click",c.hitch(this,function(){q(a)})),B.animate({right:b.getPanel().width()+6},"easeOutCirc")}),a.consumeOrigin&&C[a.consumeOrigin]&&(b=C[a.consumeOrigin],b.changeOrigin(a.origin),b.shiftTarget(a.target),delete C[a.consumeOrigin],C[a.origin]=b),C[a.origin]?C[a.origin].update(a):a.update||(b=l(a),C[a.origin]=b,i.executeOnDone(C,function(b,c){b&&b.getOrigin()!==a.origin?q({origin:b.getOrigin()},200,c):c.resolve(!0)},e))}function q(a,b,c){var e=new d(function(){c&&c.cancel()});e.then(function(){delete C[a.origin],c&&c.resolve(!0)}),C[a.origin]&&(C[a.origin].destroy(b,e),B.animate({right:3},"easeOutCirc"))}function r(a){var b=a.target||w.getPanelContainer(),c=C[a.origin];c&&c.shiftTarget(b)}function s(a){var b;a.consumeOrigin===a.origin&&C[a.consumeOrigin]?(b=C[a.origin],b.shiftTarget(a.target)):a.consumeOrigin&&C[a.consumeOrigin]&&(b=C[a.consumeOrigin],b.changeOrigin(a.origin),b.shiftTarget(a.target),delete C[a.consumeOrigin],C[a.origin]=b)}var t,u,v,w,x=$(window),y=($("#wb-head"),$("#wb-core"),$("#wb-main-in"),$("#wb-foot")),z=$("ul#tabs"),A=($("#map-div"),$("#mapContent")),B=A.find("#map-load-indicator"),C={},D={panelName:"",title:"",content:null,containerClass:"",target:null,origin:"",guid:"",update:!1,doOnOpen:null,doAfterOpen:null,doOnHide:null,doAfterHide:null,doOnDestroy:null,doAfterUpdate:null,showChars:170},E={_closing:!1,_destroyDeferred:null,_attr:null,_visible:!1,container:null,panel:null,_subPanelContentDiv:null,_panelTitle:null,_panelContentDiv:null,_animatePanelDuration:500,timeLine:null,parseContent:function(a){return("object"===jQuery.type(a)?a:$(a)).find(".shorten-candidate").shorten({showChars:this._attr.showChars}).removeClass("shorten-candidate").end()},getAttributes:function(){return this._attr},getContainer:function(){return this.container},getPanel:function(){return this.panel},getOrigin:function(){return this._attr.origin},getGuid:function(){return this._attr.guid},destroy:function(a,b){this._attr.doOnHide&&this._attr.doOnHide(),this._closing=!0,this._destroyDeferred=b,this._subPanelContentDiv.find(".fadeInDown").removeClass("fadeInDown"),w.getPanelContainer().before(this.container),n(this),this.timeLine.eventCallback("onReverseComplete",function(){this._attr.doAfterHide&&this._attr.doAfterHide(),this._attr.doOnDestroy&&this._attr.doOnDestroy(),this._visible=!1,m(!1,this._attr.origin,null),this.container.remove(),b&&b.resolve(!0)},[],this),this.timeLine.reverse()},reopen:function(){this.timeLine.pause(),this._closing=!1,this._destroyDeferred&&(this._destroyDeferred.cancel(),this._destroyDeferred=null),this.open()},open:function(){this._attr.doOnOpen&&this._attr.doOnOpen(),this._visible=!0,m(!0,this._attr.origin,this.container),this.timeLine.play()},changeOrigin:function(a){this._attr.origin=a},shiftTarget:function(a){this._attr.target!==a&&(this._subPanelContentDiv.find(".fadeInDown").removeClass("fadeInDown"),a.after(this.container),this._attr.target=a)},create:function(a){var b,d,e;a.guid=a.guid||i.guid(),c.mixin(this._attr,a),b=String.format(h,this._attr.panelName,this._attr.title),d=String.format(g,this._attr.containerClass,b),this.container=this._attr.target.after(d).parent().find(".sub-panel-container"),this.panel=this.container.find(".sub-panel"),this._subPanelContentDiv=this.panel.find(".sub-panel-content"),this._panelTitle=this.panel.find(".panel-title"),this._panelContentDiv=this.panel.find(".panel-content-div"),e=this.parseContent(this._attr.content),this._panelContentDiv.empty().append(e),this.timeLine=new TimelineLite({paused:!0,onComplete:function(){this._attr.doAfterOpen&&this._attr.doAfterOpen()},onCompleteScope:this}).to(this.panel,this._animatePanelDuration/1e3,{left:0,ease:"easeOutCirc"}),this.update(this._attr)},update:function(a){var b=300,e='<ul class="loadingAnimation"><li></li><li></li><li></li><li></li><li></li><li></li></ul>',f=[new d,new d],g=function(a,d,e){d&&(a.addClass("animated fadeOutDown"),window.setTimeout(c.hitch(this,function(){a.empty().append(d).removeClass("fadeOutDown").addClass("animated fadeInDown"),e.resolve()}),b))},h=function(a,b,c,d,f,h){c=null===c?d=e:c,c&&c!==b?f?g(a,d,h):(a.empty().append(d),h.resolve()):h.resolve()},j=c.hitch(this,function(a){this._subPanelContentDiv.animate({scrollTop:0},b,"easeOutCirc"),h(this._panelTitle,this._attr.title,a.title,a.title,this._visible,f[0]),h(this._panelContentDiv,this._attr.content,a.content,this.parseContent(a.content),this._visible,f[1]),c.mixin(this._attr,a)});i.afterAll(f,function(){a.doAfterUpdate&&a.doAfterUpdate()}),this._closing&&!a.update?(this._attr.guid!==a.guid&&(this._attr.doOnHide&&this._attr.doOnHide(),this._attr.doAfterHide&&this._attr.doAfterHide(),a.target.after(this.container),j(a)),this.reopen()):this._closing||(a.update||this._attr.guid===a.guid||(this._attr.doOnHide&&this._attr.doOnHide(),this._attr.doAfterHide&&this._attr.doAfterHide(),a.target.after(this.container),j(a),a.doOnOpen&&a.doOnOpen(),a.doAfterOpen&&a.doAfterOpen()),this._attr.guid===a.guid&&j(a))}},F=$("#helpToggle"),G=$("#help-section-container"),H=($("#help-section"),$("#addLayer-toggle")),I=$("#addLayer-section-container"),J=(y.height(),20),K=$("#gcwu-title-in .ui-link").height()/2,L=($("nav[role='navigation']:first").height()+$("#gcwu-psnb-in").height()+K+12+J,"button-pressed"),M="state-expanded",N=.5;return w=function(){function a(){L||b.publish(f.GUI.LAYOUT_CHANGE)}function c(){return n||(n=G.width()),n}function d(a){b.publish(f.GUI.PANEL_CHANGE,{visible:a})}function e(b){P.eventCallback("onReverseComplete",function(){a(),d(!0),b.resolve()},[],this),P.reverse()}function g(b){P.eventCallback("onComplete",function(){i.subscribeOnce("map/update-end",function(){d(!1)}),a(),b.resolve()},[],this),P.play()}function h(a){L=i.isUndefined(a)?!L:L,j.forEachEntry(C,function(a){q({origin:a})}),L?(TweenLite.fromTo(G,N,{width:430,right:0,left:"auto"},{left:35,right:0,width:"auto",ease:"easeOutCirc"}),O.play()):(TweenLite.fromTo(G,N,{left:35,width:"auto",right:G.css("right")},{right:0,width:430,ease:"easeInCirc"}),O.reverse())}function l(a){J=i.isUndefined(a)?!J:a,J?K.play():K.reverse(),b.publish(f.GUI.FULLSCREEN_CHANGE,{fullscreen:J})}var m,n,o=$("html"),p=$("body"),r=($("#wb-head"),$("#wb-head-in")),s=$("#wb-core"),t=($("#wb-main-in"),$("#wb-foot")),u=$("#gcwu-bnr"),v=$("#gcwu-psnb-in"),w=$("#gcwu-title-in a"),y=($("#gcwu-title-in .cn-site-title-italic"),v.find(".mb-menu"),$("nav[role='navigation']:first")),z=(v.find(".wet-boew-menubar"),$(".viewport")),A=$("#map-div"),B=$("#mapContent"),D=$("#fullScreenToggle"),E=$("#map-toolbar"),F=$("#basemapControls"),G=$("#panel-div"),H=$("#panel-toggle"),I=.5,J=!1,K=new TimelineLite({paused:!0,onComplete:a,onReverseComplete:a}),L=!1,O=new TimelineLite({paused:!0,onComplete:function(){},onReverseComplete:function(){a()}}),P=new TimelineLite({paused:!0});return o.hasClass("theme-gcwu-fegc")?K.set(r,{position:"relative"}).set(w,{overflow:"hidden"}).to(r,N,{top:"-70px",height:"124px"},0).to(w,N,{height:"35px"},0).set(v,{display:"none"}):o.hasClass("theme-gcwu-intranet")&&K.to(u,N,{height:54,ease:"easeOutCirc"},0).to(y,N,{height:0,ease:"easeOutCirc"},0).set([y,v],{display:"none"}),K.to(s,N,{top:"55px",bottom:"10px",ease:"easeOutCirc"},0).to(t,N,{height:10,ease:"easeOutCirc"},0).call(function(){i.executeOnDone(C,function(a){})},null,this,0).set(p,{className:"+=full-screen"}),O.set(z,{className:"+=full-data-mode"}).fromTo(A,N,{width:"auto"},{right:"auto",width:34,ease:"easeOutCirc"},0).fromTo(B,N,{opacity:1},{opacity:0,ease:"easeOutCirc"},0).set(B,{top:"500px"}).to(H,N,{right:-13,ease:"easeOutCirc"},0).set(H,{display:"none"}).to(F,N/2,{opacity:0,ease:"easeOutCirc"},0).to(F,0,{display:"none"},N/2).fromTo(E,N/2,{width:"100%",height:"32px"},{width:31,height:$("#map-div").height(),ease:"easeOutCirc"},I/2).to(E.find(".map-toolbar-item-button span"),N/2,{width:0,ease:"easeOutCirc"},0).set(E.find(".map-toolbar-item-button span"),{display:"none"},N/2).fromTo(G.find(".tabs li:first"),N,{width:"50%"},{width:"0%",ease:"easeOutCirc"},0).fromTo(G.find(".tabs li:last"),N,{width:"50%"},{width:"100%",ease:"easeOutCirc"},0),P.fromTo(G,N,{right:0},{right:-c(),ease:"easeOutCirc"},0).fromTo(A,N,{right:c()},{right:0,ease:"easeOutCirc"},0),{init:function(){m=k.registerPopup(H,"click",e,{activeClass:M,closeHandler:g}),b.subscribe(f.GUI.PANEL_TOGGLE,function(){m.toggle()}),B.height()<.6*x.height()&&l(!0),D.click(function(){l()})},isFullScreen:function(){return J},toggleFullScreenMode:function(a){l(a)},isFullData:function(){return L},toggleFullDataMode:function(a){h(a)},getPanelContainer:function(){return G},getPanelWidth:function(){return G.filter(":visible").width()}}}(),{load:function(c,d,e){w.init(),u=k.registerPopup(F,"click",function(a){b.publish(f.GUI.HELP_PANEL_CHANGE,{visible:!0}),G.slideToggle("fast",function(){a.resolve()})},{activeClass:L,target:G,closeHandler:function(a){b.publish(f.GUI.HELP_PANEL_CHANGE,{visible:!1}),G.slideToggle("fast",function(){a.resolve()})}}),b.subscribe(f.BookmarkLink.GETLINK_PANEL_CHANGED,function(a){u.isOpen()&&a.visible&&u.close()}),v=k.registerPopup(H,"click",function(a){b.publish(f.GUI.ADD_LAYER_PANEL_CHANGE,{visible:!0}),I.slideToggle("fast",function(){a.resolve()})},{activeClass:L,target:I,closeHandler:function(a){b.publish(f.GUI.ADD_LAYER_PANEL_CHANGE,{visible:!1}),I.slideToggle("fast",function(){a.resolve()})}}),b.subscribe(f.BookmarkLink.GETLINK_PANEL_CHANGED,function(a){v.isOpen()&&a.visible&&v.close()}),$("#addLayer-add").on("click",function(){b.publish(f.Map.ADD_LAYER,null),I.slideToggle("fast")}),b.subscribe("gui/grid/expand",function(){w.toggleFullDataMode()}),b.subscribe(f.GUI.TOGGLE_FULLSCREEN,function(a){toggleFullScreenMode(a.expand)}),b.subscribe(f.GUI.SUBPANEL_OPEN,function(a){p(a)}),b.subscribe(f.GUI.SUBPANEL_CLOSE,function(b){"all"===b.origin?j.forEachEntry(C,function(a){q({origin:a})}):a.forEach(b.origin.split(","),function(a){q({origin:a})})}),b.subscribe(f.GUI.SUBPANEL_DOCK,function(a){r(a)}),b.subscribe(f.GUI.SUBPANEL_CAPTURE,function(b){var c;"all"===b.consumeOrigin?j.forEachEntry(C,function(a){c=Object.create(b),c.consumeOrigin=a,s(c)}):a.forEach(b.consumeOrigin.split(","),function(a){c=Object.create(b),c.consumeOrigin=a,s(c)})}),z.find("li a").click(function(){b.publish(f.GUI.TAB_SELECTED,{id:this.id,tabName:this.attributes["data-panel-name"].value}),z.find("li:not(.active) a").each(function(){b.publish(f.GUI.TAB_DESELECTED,{id:this.id,tabName:this.attributes["data-panel-name"].value})})}),o(),k.registerPopup($("#tools"),"hoverIntent",function(a){$("#tools-container").slideDown("fast",function(){a.resolve()})},{activeClass:L,target:$("#tools-container"),closeHandler:function(a){$("#tools-container").slideUp("fast",function(){a.resolve()})},timeout:500}),e()}}});